name: Database Backup

on:
  schedule:
    # Daily backup at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Backup type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - schema-only
          - data-only

concurrency:
  group: backup
  cancel-in-progress: false

jobs:
  backup:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    
    steps:
      - name: Set backup type
        run: |
          BACKUP_TYPE="${{ github.event.inputs.backup_type || 'full' }}"
          echo "BACKUP_TYPE=$BACKUP_TYPE" >> $GITHUB_ENV
          echo "ğŸ—„ï¸ Starting $BACKUP_TYPE backup"

      - name: Database backup with enhanced error handling
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USERNAME }}
          password: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          command_timeout: 25m
          script: |
            set -e  # Exit on any error
            
            cd ~/qrent/
            
            # Ensure backup script exists
            if [ ! -f "./scripts/db-backup.sh" ]; then
              echo "âŒ Backup script not found at ./scripts/db-backup.sh"
              exit 1
            fi
            
            # Set environment variables
            export MYSQL_ROOT_PASSWORD='${{ secrets.DB_ROOT_PASSWORD }}'
            export BACKUP_TYPE='${{ env.BACKUP_TYPE }}'
            export BACKUP_TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ğŸ“Š Pre-backup database status:"
            docker compose exec -T db mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SHOW DATABASES;" || exit 1
            
            echo "ğŸš€ Starting backup process..."
            bash ./scripts/db-backup.sh
            
            # Verify backup was created
            BACKUP_FILE="backup_${BACKUP_TIMESTAMP}.sql"
            if [ -f "$BACKUP_FILE" ] || [ -f "backups/$BACKUP_FILE" ]; then
              BACKUP_SIZE=$(du -h backup* backups/backup* 2>/dev/null | tail -1 | cut -f1 || echo "unknown")
              echo "âœ… Backup completed successfully - Size: $BACKUP_SIZE"
            else
              echo "âŒ Backup file not found after script execution"
              exit 1
            fi

      - name: Backup verification and cleanup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER_HOST }}
          username: ${{ secrets.DEPLOY_SERVER_USERNAME }}
          password: ${{ secrets.DEPLOY_SERVER_PASSWORD }}
          script: |
            cd ~/qrent/
            
            echo "ğŸ” Listing recent backups:"
            find . -name "*.sql" -mtime -1 -exec ls -lh {} \; 2>/dev/null || echo "No recent backups found"
            
            echo "ğŸ§¹ Cleaning old backups (keeping last 7 days):"
            find . -name "backup_*.sql" -mtime +7 -delete 2>/dev/null || true
            find ./backups -name "backup_*.sql" -mtime +7 -delete 2>/dev/null || true
            
            echo "ğŸ“ˆ Current backup storage usage:"
            du -sh backup* backups/ 2>/dev/null || echo "No backup directory found"

  backup-health-check:
    runs-on: ubuntu-latest
    needs: [backup]
    if: always()
    steps:
      - name: Backup status notification
        run: |
          if [[ "${{ needs.backup.result }}" == "success" ]]; then
            echo "âœ… Database backup completed successfully"
            echo "ğŸ“… Backup type: ${{ env.BACKUP_TYPE }}"
            echo "ğŸ•’ Completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          else
            echo "âŒ Database backup failed!"
            echo "ğŸš¨ Manual intervention may be required"
            exit 1
          fi